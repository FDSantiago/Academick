# Production Docker Compose Configuration for Coolify
# This file defines the Laravel application service for production deployment
# Coolify will handle port mapping, SSL/TLS, and environment variable injection

services:
  app:
    # Build from local Dockerfile
    build:
      context: .
      dockerfile: Dockerfile
    
    # Container name for easier identification
    container_name: academick-app
    
    # Expose port 80 for Coolify's reverse proxy
    # Coolify will map this to the appropriate external port
    ports:
      - "80:80"
    
    # Persistent volumes for SQLite database and storage
    # These ensure data persists across container restarts and redeployments
    volumes:
      # Storage directory: logs, cache, sessions, uploaded files
      - ./storage:/var/www/html/storage
      # Database directory: SQLite database file
      - ./database:/var/www/html/database
    
    # Production environment variables
    # Note: Coolify will override these with its own environment management
    environment:
      - APP_ENV=production
      - APP_DEBUG=false
      # APP_KEY will be set by Coolify's environment variables
      # Database configuration for SQLite
      - DB_CONNECTION=sqlite
      - DB_DATABASE=/var/www/html/database/database.sqlite
      # Cache and session drivers using SQLite
      - CACHE_DRIVER=database
      - SESSION_DRIVER=database
      - QUEUE_CONNECTION=database
    
    # Health check to verify the application is running
    # Coolify uses this to monitor container health
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    
    # Restart policy for high availability
    # Container will restart automatically unless explicitly stopped
    restart: unless-stopped
    
    # Resource limits (optional, adjust based on your needs)
    # Uncomment and modify if you need to limit resource usage
    # deploy:
    #   resources:
    #     limits:
    #       cpus: '1'
    #       memory: 1G
    #     reservations:
    #       cpus: '0.5'
    #       memory: 512M

# Network configuration
# Coolify will manage networking, but we define a custom network for clarity
networks:
  default:
    name: academick-network